name: Build OpenWrt with USB and SWAP
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget libelf-dev
    
    - name: Clone OpenWrt
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git
        cd openwrt
        git checkout v24.10.4
    
    - name: Apply USB patch
      run: |
        cd openwrt
        sed -i 's/status = "disabled";/status = "okay";/g' target/linux/ramips/dts/mt7628an_xiaomi_mi-router-4c.dts
        cat target/linux/ramips/dts/mt7628an_xiaomi_mi-router-4c.dts | grep -A 2 "ehci\|ohci"
    
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: Configure
      run: |
        cd openwrt
        cat > .config << 'EOF'
        CONFIG_TARGET_ramips=y
        CONFIG_TARGET_ramips_mt76x8=y
        CONFIG_TARGET_ramips_mt76x8_DEVICE_xiaomi_mi-router-4c=y
        
        # === KERNEL SWAP SUPPORT ===
        CONFIG_KERNEL_SWAP=y
        CONFIG_KERNEL_SWAP_WORKINGSET=y
        
        # --- USB ---
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-ohci=y
        CONFIG_PACKAGE_kmod-usb-ehci=y
        CONFIG_PACKAGE_kmod-usb2=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_kmod-usb-storage-extras=y
        CONFIG_PACKAGE_kmod-scsi-core=y
        CONFIG_PACKAGE_usbutils=y
        
        # --- Файловые системы ---
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-fs-exfat=y
        CONFIG_PACKAGE_kmod-fs-ntfs=y
        CONFIG_PACKAGE_kmod-fuse=y
        CONFIG_PACKAGE_ntfs-3g=y
        CONFIG_PACKAGE_kmod-nls-base=y
        CONFIG_PACKAGE_kmod-nls-cp437=y
        CONFIG_PACKAGE_kmod-nls-iso8859-1=y
        CONFIG_PACKAGE_kmod-nls-utf8=y
        
        # --- Swap поддержка ---
        CONFIG_SWAP=y
        CONFIG_PACKAGE_swap-utils=y
        CONFIG_PACKAGE_zram-swap=y
        
        # --- Базовые утилиты ---
        CONFIG_PACKAGE_mount-utils=y
        CONFIG_PACKAGE_fstools=y
        CONFIG_PACKAGE_block-mount=y
        CONFIG_PACKAGE_blockd=y
        CONFIG_PACKAGE_lsblk=y
        CONFIG_PACKAGE_parted=y
        CONFIG_PACKAGE_e2fsprogs=y
        CONFIG_PACKAGE_fdisk=y
        
        # --- LuCI и Travelmate ---
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_luci-app-travelmate=y
        CONFIG_PACKAGE_luci-i18n-base-ru=y
        CONFIG_PACKAGE_luci-i18n-firewall-ru=y
        CONFIG_PACKAGE_travelmate=y
        CONFIG_PACKAGE_curl=y
        EOF
        make defconfig
    
    - name: Verify SWAP config
      run: |
        cd openwrt
        echo "=== Checking SWAP configuration ==="
        grep -i swap .config || echo "No SWAP config found!"
    
    - name: Build
      run: |
        cd openwrt
        make -j$(nproc) V=s
    
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-usb-swap
        path: openwrt/bin/targets/ramips/mt76x8/*sysupgrade.bin
